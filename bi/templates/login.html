<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DeepBI网页应用鉴权123</title>
    <script src="/static/jquery.js"></script>
    <!-- 引入 JSSDK -->
    <!-- JS 文件版本在升级功能时地址会变化，如有需要（比如使用新增的 API），请重新引用「网页应用开发指南」中的JSSDK链接，确保你当前使用的JSSDK版本是最新的。-->
    <script
      type="text/javascript"
      src="https://lf1-cdn-tos.bytegoofy.com/goofy/lark/op/h5-js-sdk-1.5.16.js"
    ></script>
    <!-- 在页面上添加VConsole方便调试-->
    <script src="https://unpkg.com/vconsole/dist/vconsole.min.js"></script>
    <script>
      var vConsole = new window.VConsole();
    </script>
  </head>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #ebf1fd;
    }

    .header {
      display: flex;
      flex-direction: column;
      background-color: white;
    }

    .header .time-message {
      display: flex;
      height: 44px;
      align-items: center;
      padding: 0 33.5px;
      justify-content: space-between;
    }

    .header .title {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 44px;
    }

    .header .title span {
      font-weight: 500;
      font-size: 17px;
    }

    .img {
      width: 120px;
      height: 239px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      flex-direction: column;
    }

    .img_div {
      border-radius: 50%;
      overflow: hidden;
      width: 88px;
      height: 88px;
      border: 3px white solid;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .text_hello {
      font-size: 26px;
      font-weight: 600;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .text_hello_name {
      font-size: 20px;
      color: #3370ff;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, 50%);
      text-align: center;
    }

    .text_hello_welcome {
      position: absolute;
      bottom: 0;
      size: 20px;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
    }

    .icon {
      position: absolute;
      bottom: 44px;
      left: 50%;
      transform: translate(-50%, 0);
    }
  </style>
  <body>
    <div>
      <div class="img">
          <!-- 头像 -->
          <div
                  id="img_div"
                  class="img_div"
          >
          </div>
          
          <span
                  class="hello_text"
          >Hello</span
          >
          <!-- 名称 -->
          <div
                  id="hello_text_name"
                  class="hello_text_name"
          ></div>
          <!-- 欢迎语 -->
          <div
                  id="hello_text_welcome"
                  class="hello_text_welcome"
          >
          </div>
      </div>
  </div>
    <script>
      const login_info = '{{ login_info }}';
    console.log("login info: ", login_info);
    if (login_info == "alreadyLogin") {
        const user_info = JSON.parse('{{ user_info | tojson | safe }}');
        console.log("user: ", user_info.name);
        $('document').ready(showUser(user_info))
    } else {
        $('document').ready(apiAuth())
    }



    let lang = window.navigator.language;
console.log(lang);


function apiAuth() {
    if (!window.h5sdk) {
        console.log('invalid h5sdk')
        alert('please open in feishu')
        return
    }

    // 通过服务端的Route: get_appid获取app_id
    // 服务端Route: get_appid的具体内容请参阅服务端模块server.py的get_appid()函数
    // 为了安全，app_id不应对外泄露，尤其不应在前端明文书写，因此此处从服务端获取
    fetch(`/get_appid`).then(response1 => response1.json().then(res1 => {
        console.log("get appid succeed: ", res1.appid);
        // 通过error接口处理API验证失败后的回调
        window.h5sdk.error(err => {
            throw('h5sdk error:', JSON.stringify(err));
        });
        // 通过ready接口确认环境准备就绪后才能调用API
        window.h5sdk.ready(() => {
            console.log("window.h5sdk.ready");
            console.log("url:", window.location.href);
            // 调用JSAPI tt.requestAuthCode 获取 authorization code
            tt.requestAuthCode({
                appId: res1.appid,
                // 获取成功后的回调
                success(res) {
                    console.log("getAuthCode succeed");
                    //authorization code 存储在 res.code
                    // 此处通过fetch把code传递给接入方服务端Route: callback，并获得user_info
                    // 服务端Route: callback的具体内容请参阅服务端模块server.py的callback()函数
                    fetch(`/callback?code=${res.code}`).then(response2 => response2.json().then(res2 => {
                        console.log("getUserInfo succeed");
                        // 示例Demo中单独定义的函数showUser，用于将用户信息展示在前端页面上
                        showUser(res2);}
                        )
                    ).catch(function (e) {console.error(e)})
                },
                // 获取失败后的回调
                fail(err) {
                    console.log(`getAuthCode failed, err:`, JSON.stringify(err));
                }
            })
        }
        )
    })).catch(function (e) { // 从服务端获取app_id失败后的处理
        console.error(e)
        })
}

function showUser(res) {
    // 展示用户信息
    // 头像
    $('#img_div').html(`<img src="${res.avatar_url}" width="100%" height=""100%/>`);
    // 名称
    $('#hello_text_name').text(lang === "zh_CN" || lang === "zh-CN" ? `${res.name}` : `${res.en_name}`);
    // 欢迎语
    $('#hello_text_welcome').text(lang === "zh_CN" || lang === "zh-CN" ? "欢迎使用飞书" : "welcome to Feishu");
    // 登录完成
    loginSuccess();
  }

// 登录完成
function loginSuccess() {
  fetch(`/login_success`).then(response => response.json().then(res => {
    console.log("login success: ", res);
  })).catch(function (e) {
    console.error(e);
  })
}

    </script>
  </body>
</html>
